<html>
  <head>
    <title>RE Calculator</title>
    <style></style>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
  </head>

  <body>
    <!-- some HTML -->
    <div id="root"></div>
    <!-- some other HTML -->
  </body>
</html>

<div>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- babel is required in order to parse JSX -->

  <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <!-- import react.js -->

  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <!-- import react-dom.js -->

  <!-- <script src="https://unpkg.com/react-use-localstorage@3.4.1/dist/react-use-localstorage.cjs.development.js">
	</script> -->
  <!-- import localstorage.js -->

  <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"> </script> -->
  <!-- import bootstrap.js -->

  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
		integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->

  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous"
  />

  <!-- <script src="https://unpkg.com/react/umd/react.production.min.js" crossorigin></script> -->

  <!-- // <script
	// 	src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"
	// 	crossorigin
	// /> -->

  <script
    src="https://unpkg.com/react-bootstrap@next/dist/react-bootstrap.min.js"
    crossorigin
  ></script>

  <!-- // <script>
		var Alert = ReactBootstrap.Alert;
	</script> -->

  <script type="text/babel">
    function useLocalStorage(key, initialValue) {
      // State to store our value
      // Pass initial state function to useState so logic is only executed once
      const [storedValue, setStoredValue] = React.useState(() => {
        try {
          // Get from local storage by key
          const item = window.localStorage.getItem(key);
          // Parse stored json or if none return initialValue
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          // If error also return initialValue
          console.log(error);
          return initialValue;
        }
      });

      // Return a wrapped version of useState's setter function that ...
      // ... persists the new value to localStorage.
      const setValue = value => {
        try {
          // Allow value to be a function so we have same API as useState
          const valueToStore =
            value instanceof Function ? value(storedValue) : value;
          // Save state
          setStoredValue(valueToStore);
          // Save to local storage
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {
          // A more advanced implementation would handle the error case
          console.log(error);
        }
      };

      return [storedValue, setValue];
    }

    // Helper functions

    const Helpers = (() => {
      const calculateTotalProjectCost = ({
        purchasePrice,
        estimatedRepairs,
        purchaseClosingCosts,
        preRentHoldingCosts
      } = form) => {
        const totalProjectCost =
          (purchasePrice || 0) +
          (estimatedRepairs || 0) +
          (purchaseClosingCosts || 0) +
          (preRentHoldingCosts || 0);
        return totalProjectCost;
      };

      const calculateLoan = ({
        downPaymentPercentage = 0,
        purchasePrice = 0
      } = form) => {
        const loan = (purchasePrice * (100 - downPaymentPercentage)) / 100;

        return loan;
      };

      const calculateOutOfPocket = form => {
        const totalProjectCost = calculateTotalProjectCost(form);
        const loan = calculateLoan(form);
        const outOfPocket = totalProjectCost - loan;

        return outOfPocket;
      };

      const calculateValueByPercentage = (totalValue = 0, percentage = 0) => {
        const percentageValue = (percentage / 100) * totalValue;

        return percentageValue;
      };

      const calculateMonthlyMortgagePayment = form => {
        const { loanPeriod, interestRate } = form;
        const loan = calculateLoan(form);

        // allow calculation for 0% interest rate
        if (!interestRate) {
          return loan / (loanPeriod * 12);
        }

        // https://www.thebalance.com/calculate-mortgage-315668
        // P = A/D where D = {[(1 + i) ^n] - 1} / [i(1 + i)^n]
        const n = loanPeriod * 12; // 12 months
        const i = interestRate / 100 / 12; // 12 months
        const D = (Math.pow(1 + i, n) - 1) / (i * Math.pow(1 + i, n));
        const monthlyMortgagePayment = loan / D;

        return monthlyMortgagePayment;
      };

      const calculateTotalExpenses = form => {
        const {
          rent,
          vacancyRate,
          repairsRate,
          capitalExpendituresRate,
          insuranceRate,
          propertyManagementRate,
          purchasePrice,
          taxRate,
          floodInsuranceMonthlyCost,
          electricityMonthlyCost,
          waterMonthlyCost,
          sewerMonthlyCost,
          gasMonthlyCost,
          garbageMonthlyCost,
          hoaMonthlyCost
        } = form;
        const mortgage = calculateMonthlyMortgagePayment(form);
        const vacancyCost = calculateValueByPercentage(rent, vacancyRate);
        const repairsCost = calculateValueByPercentage(rent, repairsRate);
        const capitalExpendituresCost = calculateValueByPercentage(
          rent,
          capitalExpendituresRate
        );
        const insuranceCost = calculateValueByPercentage(
          purchasePrice / 12,
          insuranceRate
        );
        const taxCost = calculateValueByPercentage(purchasePrice / 12, taxRate);
        const propertyManagementMonthlyCost = calculateValueByPercentage(
          rent,
          propertyManagementRate
        );

        const totalExpenses =
          mortgage +
          vacancyCost +
          repairsCost +
          capitalExpendituresCost +
          insuranceCost +
          taxCost +
          (floodInsuranceMonthlyCost || 0) +
          (electricityMonthlyCost || 0) +
          (waterMonthlyCost || 0) +
          (sewerMonthlyCost || 0) +
          (gasMonthlyCost || 0) +
          (garbageMonthlyCost || 0) +
          (hoaMonthlyCost || 0) +
          propertyManagementMonthlyCost;

        return totalExpenses;
      };

      return {
        calculateTotalProjectCost: calculateTotalProjectCost,
        calculateOutOfPocket: calculateOutOfPocket,
        calculateValueByPercentage: calculateValueByPercentage,
        calculateLoan: calculateLoan,
        calculateMonthlyMortgagePayment: calculateMonthlyMortgagePayment,
        calculateTotalExpenses: calculateTotalExpenses
      };
    })();

    Number.prototype.toCurrency = function() {
      if (isNaN(this.valueOf())) {
        return 0;
      }

      const formattedValue = this.valueOf().toLocaleString(undefined, {
        maximumFractionDigits: 2
      });

      return formattedValue;
    };

    // end of Helper Functions

    const SingleInput = ({
      label,
      inputName,
      inputValue,
      additionalInfoText,
      handleOnChange,
      disabled,
      prefix,
      suffix,
      required,
      roundValue = true
    } = props) => {
      let isInvalid = "";
      if (required && !inputValue) {
        isInvalid = "is-invalid";
      }

      const value = roundValue ? Math.ceil(inputValue) : inputValue;

      return (
        <div className="input-group row py-1 ">
          <label className="col-md-2">{label}</label>
          <div className="col-md-4">
            <div className="input-group">
              <div className="input-group-prepend">
                <span className="input-group-text">{prefix}</span>
              </div>
              <input
                className={"form-control " + isInvalid}
                type="number"
                name={inputName}
                value={value || ""}
                onChange={handleOnChange}
                disabled={disabled ? "disabled" : ""}
              />
              <div className="input-group-append">
                <span className="input-group-text">{suffix}</span>
              </div>
            </div>
          </div>
          <div className="col-md-2">{additionalInfoText}</div>
        </div>
      );
    };

    const MonthYearInput = ({
      label,
      inputName,
      inputValue,
      handleOnChange,
      setFormValueByName
    } = props) => {
      return (
        <div className="input-group row py-1 ">
          <label className="col-md-2">{label}</label>
          <div className="col-md-4">
            <div className="input-group">
              <div className="input-group-prepend">
                <span className="input-group-text">$</span>
              </div>
              <input
                className="form-control"
                type="number"
                name={inputName}
                value={Math.ceil(inputValue) || ""}
                onChange={handleOnChange}
              />
              <div className="input-group-append">
                <span className="input-group-text">/mo.</span>
              </div>
            </div>
          </div>
          <div className="col-md-3">
            <div className="input-group">
              <input
                className="form-control"
                type="number"
                value={inputValue * 12 || ""}
                onChange={e =>
                  setFormValueByName(Number(e.target.value) / 12, inputName)
                }
              />
              <div className="input-group-append">
                <span className="input-group-text">/yr.</span>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const MonthYearPercentInput = ({
      label,
      inputName,
      additionalInfoText,
      percentageValue,
      wholeMonthlyValue,
      handleOnChange,
      setFormValueByName,
      disableYear,
      monthAppendValue
    } = props) => {
      const monthlyValue = Helpers.calculateValueByPercentage(
        wholeMonthlyValue,
        percentageValue
      );

      const getYearInput = () => {
        if (disableYear) {
          return null;
        }
        return (
          <div className="col-md-3">
            <div className="input-group">
              <input
                className="form-control"
                type="number"
                value={Math.ceil(monthlyValue * 12) || ""}
                onChange={e =>
                  setFormValueByName(
                    inputName,
                    (Number(e.target.value) / 12 / wholeMonthlyValue) * 100
                  )
                }
              />
              <div className="input-group-append">
                <span className="input-group-text">/yr.</span>
              </div>
            </div>
          </div>
        );
      };
      return (
        <div className="input-group row py-1">
          <label className="col-md-2">{label}</label>
          {/* Monthly Input */}
          <div className="col-md-4">
            <div className="input-group">
              <div className="input-group-prepend">
                <span className="input-group-text">$</span>
              </div>
              <input
                className="form-control"
                type="number"
                value={Math.ceil(monthlyValue) || ""}
                onChange={e =>
                  setFormValueByName(
                    inputName,
                    (Number(e.target.value) / wholeMonthlyValue) * 100
                  )
                }
              />
              <div className="input-group-append">
                <span className="input-group-text">{monthAppendValue}</span>
              </div>
            </div>
          </div>
          {getYearInput()}
          {/* Percentage Input */}
          <div className="col-md-3">
            <div className="input-group">
              <input
                className="form-control"
                type="number"
                value={percentageValue}
                name={inputName}
                onChange={handleOnChange}
              />
              <div className="input-group-append">
                <span className="input-group-text">%</span>
              </div>
            </div>
          </div>
          <div className="col-md-12">
            <span className="mx-auto">{additionalInfoText}</span>
          </div>
        </div>
      );
    };

    const Part0 = ({ form, handleOnChange } = props) => {
      return (
        <div>
          <SingleInput
            label="Asking Price"
            inputName="askingPrice"
            inputValue={form.askingPrice}
            handleOnChange={handleOnChange}
            prefix={"$"}
          />
        </div>
      );
    };

    // Total Project Cost
    const Part1 = ({ form, handleOnChange } = props) => {
      return (
        <div>
          <h2>
            1) Total Project Cost: $
            {Helpers.calculateTotalProjectCost(form).toCurrency()}
          </h2>
          <SingleInput
            label="Purchase Price"
            inputValue={form.purchasePrice}
            inputName="purchasePrice"
            handleOnChange={handleOnChange}
            prefix={"$"}
            required="true"
          />
          <SingleInput
            label="Purchase Closing Costs"
            inputValue={form.purchaseClosingCosts}
            inputName="purchaseClosingCosts"
            handleOnChange={handleOnChange}
            prefix={"$"}
          />

          <SingleInput
            label="Pre-Rent Holding Costs"
            inputValue={form.preRentHoldingCosts}
            inputName="preRentHoldingCosts"
            handleOnChange={handleOnChange}
            prefix={"$"}
          />

          <SingleInput
            label="Estimated Repairs"
            inputValue={form.estimatedRepairs}
            inputName="estimatedRepairs"
            handleOnChange={handleOnChange}
            prefix={"$"}
          />

          <SingleInput
            label="Total Project Cost"
            inputValue={Helpers.calculateTotalProjectCost(form)}
            prefix={"$"}
            disabled={true}
          />
        </div>
      );
    };

    const Part2 = ({ form, handleOnChange, setFormValueByName } = props) => {
      const loan = Helpers.calculateLoan(form);
      const outOfPocket = Helpers.calculateOutOfPocket(form);
      return (
        <div>
          <h2>
            2) Total Cost Out of Pocket: $
            {Helpers.calculateOutOfPocket(form).toCurrency()}
          </h2>
          <MonthYearPercentInput
            label="Down Payment"
            inputName="downPaymentPercentage"
            percentageValue={form.downPaymentPercentage}
            wholeMonthlyValue={form.purchasePrice}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
            disableYear={true}
          />

          <SingleInput
            label="Loan"
            prefix={"$"}
            disabled={true}
            inputValue={loan}
          />

          <SingleInput
            label="Out of Pocket"
            inputValue={outOfPocket}
            prefix={"$"}
            disabled={true}
          />
        </div>
      );
    };

    const Part3 = ({ form, handleOnChange } = props) => {
      const loan = Helpers.calculateLoan(form);
      const outOfPocket = Helpers.calculateOutOfPocket(form);
      const monthlyMortgagePayment = Helpers.calculateMonthlyMortgagePayment(
        form
      );
      return (
        <div>
          <h2>
            3) Monthly Mortgage Payment: ${monthlyMortgagePayment.toCurrency()}
            /mo.
          </h2>
          <SingleInput
            label="Loan Period"
            inputValue={form.loanPeriod}
            inputName="loanPeriod"
            handleOnChange={handleOnChange}
            suffix="years"
          />

          <SingleInput
            label="Interest Rate"
            inputValue={form.interestRate}
            inputName="interestRate"
            handleOnChange={handleOnChange}
            suffix="%"
          />
        </div>
      );
    };

    const Part4 = ({ form, handleOnChange } = props) => {
      return (
        <div>
          <h2>4) Total Income: $ {Number(form.rent).toCurrency()}/mo.</h2>

          <SingleInput
            label="Rent"
            inputValue={form.rent}
            inputName="rent"
            handleOnChange={handleOnChange}
            prefix={"$"}
            suffix="/mo."
            required="true"
          />
        </div>
      );
    };

    // Total Expenses
    const Part5 = ({ form, handleOnChange, setFormValueByName } = props) => {
      const mortgage = Helpers.calculateMonthlyMortgagePayment(
        form
      ).toCurrency();

      return (
        <div>
          <h2>
            5) Total Expenses: ${" "}
            {Helpers.calculateTotalExpenses(form).toCurrency()}/mo.
          </h2>
          <SingleInput label="Mortgage" inputValue={mortgage} disabled={true} />

          <MonthYearPercentInput
            label="Vacancy"
            inputName="vacancyRate"
            percentageValue={form.vacancyRate}
            wholeMonthlyValue={form.rent}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
            monthAppendValue="/mo."
          />
          <MonthYearPercentInput
            label="Repairs"
            inputName="repairsRate"
            percentageValue={form.repairsRate}
            wholeMonthlyValue={form.rent}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
            monthAppendValue="/mo."
          />
          <MonthYearPercentInput
            label="Capital Expenditures"
            inputName="capitalExpendituresRate"
            percentageValue={form.capitalExpendituresRate}
            wholeMonthlyValue={form.rent}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
            monthAppendValue="/mo."
          />
          <MonthYearPercentInput
            label="Insurance"
            inputName="insuranceRate"
            percentageValue={form.insuranceRate}
            wholeMonthlyValue={form.purchasePrice / 12}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
            monthAppendValue="/mo."
          />
          <MonthYearPercentInput
            label="Taxes"
            inputName="taxRate"
            additionalInfoText=" (Hillsborough: 1.06%)"
            percentageValue={form.taxRate}
            wholeMonthlyValue={form.purchasePrice / 12}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
            monthAppendValue="/mo."
          />
          <MonthYearInput
            label="Flood Insurance"
            inputName="floodInsuranceMonthlyCost"
            inputValue={form.floodInsuranceMonthlyCost}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
          />
          <MonthYearInput
            label="Electricity"
            inputName="electricityMonthlyCost"
            inputValue={form.electricityMonthlyCost}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
          />
          <MonthYearInput
            label="Water"
            inputName="waterMonthlyCost"
            inputValue={form.waterMonthlyCost}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
          />
          <MonthYearInput
            label="Sewer"
            inputName="sewerMonthlyCost"
            inputValue={form.sewerMonthlyCost}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
          />
          <MonthYearInput
            label="Gas"
            inputName="gasMonthlyCost"
            inputValue={form.gasMonthlyCost}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
          />
          <MonthYearInput
            label="Garbage"
            inputName="garbageMonthlyCost"
            inputValue={form.garbageMonthlyCost}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
          />
          <MonthYearInput
            label="HOA"
            inputName="hoaMonthlyCost"
            inputValue={form.hoaMonthlyCost}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
          />
          <MonthYearPercentInput
            label="Property Management"
            inputName="propertyManagementRate"
            percentageValue={form.propertyManagementRate}
            wholeMonthlyValue={form.rent}
            handleOnChange={handleOnChange}
            setFormValueByName={setFormValueByName}
            monthAppendValue="/mo."
          />

          <SingleInput
            label="Total Expenses"
            inputValue={Helpers.calculateTotalExpenses(form)}
            disabled={true}
            prefix="$"
            suffix="/mo."
          />
        </div>
      );
    };

    const Defaults = ({ defaults, handleOnSubmit } = props) => {
      const [localDefaults, setLocalDefaults] = React.useState({ ...defaults });

      const handleOnChange = event => {
        setLocalDefaults({
          ...localDefaults,
          [event.target.name]: Number(event.target.value)
        });
      };

      const [showModal, setShowModal] = React.useState(false);

      const handleClose = () => setShowModal(false);
      const handleShow = () => setShowModal(true);

      const handleOnSumbit = () => {
        handleOnSubmit(localDefaults);

        handleClose();
      };

      return (
        <React.Fragment>
          <ReactBootstrap.Button
            variant="primary"
            onClick={handleShow}
            className="float-right"
          >
            Edit Defaults
          </ReactBootstrap.Button>
          <ReactBootstrap.Modal show={showModal} onHide={handleClose} size="lg">
            <ReactBootstrap.Modal.Header closeButton>
              <ReactBootstrap.Modal.Title>Defaults</ReactBootstrap.Modal.Title>
            </ReactBootstrap.Modal.Header>
            <ReactBootstrap.Modal.Body>
              <form>
                <div>
                  <SingleInput
                    label="Purchase Closing Costs"
                    inputName="purchaseClosingCosts"
                    inputValue={localDefaults.purchaseClosingCosts}
                    handleOnChange={handleOnChange}
                    prefix={"$"}
                  />
                  <SingleInput
                    label="Loan Period"
                    inputName="loanPeriod"
                    inputValue={localDefaults.loanPeriod}
                    handleOnChange={handleOnChange}
                    suffix={"years"}
                  />
                  <SingleInput
                    label="Interest Rate"
                    inputName="interestRate"
                    inputValue={localDefaults.interestRate}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                  />
                  <SingleInput
                    label="Down Payment Percentage"
                    inputName="downPaymentPercentage"
                    inputValue={localDefaults.downPaymentPercentage}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                  />
                  <SingleInput
                    label="Vacancy Rate"
                    inputName="vacancyRate"
                    inputValue={localDefaults.vacancyRate}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                  />
                  <SingleInput
                    label="Repair Percentage"
                    inputName="repairsRate"
                    inputValue={localDefaults.repairsRate}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                  />
                  <SingleInput
                    label="Capital Expenditure Percentage"
                    inputName="capitalExpendituresRate"
                    inputValue={localDefaults.capitalExpendituresRate}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                    roundValue={false}
                  />
                  <SingleInput
                    label="Insurance Rate"
                    inputName="insuranceRate"
                    inputValue={localDefaults.insuranceRate}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                    roundValue={false}
                  />
                  <SingleInput
                    label="Tax Rate"
                    inputName="taxRate"
                    inputValue={localDefaults.taxRate}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                    roundValue={false}
                  />
                  <SingleInput
                    label="Property Management Rate"
                    inputName="propertyManagementRate"
                    inputValue={localDefaults.propertyManagementRate}
                    handleOnChange={handleOnChange}
                    suffix={"%"}
                  />
                </div>
              </form>
            </ReactBootstrap.Modal.Body>
            <ReactBootstrap.Modal.Footer>
              <ReactBootstrap.Button variant="primary" onClick={handleOnSumbit}>
                Save Changes
              </ReactBootstrap.Button>
            </ReactBootstrap.Modal.Footer>
          </ReactBootstrap.Modal>
        </React.Fragment>
      );
    };

    const Container = () => {
      const [defaults, setDefaults] = useLocalStorage("defaults", "");
      // const [defaults, setDefaults] = React.useState({});

      const defaultsObject = defaults ? JSON.parse(defaults) : {};
      const [form, setForm] = React.useState({
        ...defaultsObject
      });

      React.useEffect(() => {}, [defaultsObject]);

      const handleOnChange = event => {
        setForm({
          ...form,
          [event.target.name]: Number(event.target.value)
        });
      };

      const setFormValueByName = (name, value) => {
        setForm({
          ...form,
          [name]: Number(value)
        });
      };

      const handleDefaultsSubmission = newDefaults => {
        const newDefaultsString = JSON.stringify(newDefaults);

        setDefaults(newDefaultsString);
        const newForm = { ...form, ...newDefaults };
        setForm(newForm);
      };

      return (
        <div className="container">
          <h1 className="text-center">RE Calculator</h1>

          <hr className="solid" />
          <Defaults
            defaults={defaultsObject}
            handleOnSubmit={handleDefaultsSubmission}
          />
          <form>
            <Part0 form={form} handleOnChange={handleOnChange} />
            <Part1 form={form} handleOnChange={handleOnChange} />
            <Part2
              form={form}
              handleOnChange={handleOnChange}
              setFormValueByName={setFormValueByName}
            />
            <Part3 form={form} handleOnChange={handleOnChange} />
            <Part4 form={form} handleOnChange={handleOnChange} />
            <Part5 form={form} handleOnChange={handleOnChange} />
          </form>
        </div>
      );
    };

    const element = (
      <div>
        <Container />
      </div>
    );

    ReactDOM.render(element, document.getElementById("root"));
  </script>
</div>
